{% extends "base.html" %}
{% block title %}Conciliación · Sistema de gestión de tarjetas{% endblock %}

{% block content %}
<div class="content-container">

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <div class="page-title mb-0">Conciliación</div>
      {% if has_data %}
      <div class="text-muted small">Última carga: {{ created_at }}</div>
      {% endif %}
    </div>
  </div>

  {% if not has_data %}
    <div class="text-muted">Sin datos para conciliar.</div>
  {% else %}

  <div class="filter-card mb-3">
    <form method="get" action="{{ url_for('conciliacion') }}" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label fw-semibold mb-1">Fecha</label>
        <input class="form-control" type="date" name="date" value="{{ date_str or '' }}">
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label fw-semibold mb-1">Filas por página</label>
        <select class="form-select" name="per_page">
          {% set pp = per_page or 25 %}
          <option value="25"  {% if pp == 25 %}selected{% endif %}>25</option>
          <option value="50"  {% if pp == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if pp == 100 %}selected{% endif %}>100</option>
          <option value="200" {% if pp == 200 %}selected{% endif %}>200</option>
        </select>
      </div>

      <div class="col-12 col-md-4 d-flex justify-content-end">
        <button class="btn btn-primary-custom w-100" type="submit">
          <i class="fa-solid fa-play me-1"></i> Ejecutar
        </button>
      </div>

      {# mantener selección de habitación al cambiar per_page #}
      {% if selected_room %}
        <input type="hidden" name="room" value="{{ selected_room }}">
      {% endif %}
      <input type="hidden" name="page" value="1">
    </form>
  </div>

  {% if not has_run %}
    <div class="text-muted">Selecciona una fecha (se usa la columna <strong>DIA</strong> de Ontracking).</div>
  {% else %}

    <div class="row g-3">
      <!-- IZQUIERDA: Ontracking del día + nombre(s) de apertura -->
      <div class="col-12 col-lg-7">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <div class="text-muted small">
            Página {{ page }} / {{ total_pages }} · {{ total }} registros Ontracking (DIA = {{ date_str }})
          </div>
        </div>

        {% if total == 0 %}
          <div class="text-muted">No hay registros de Ontracking para esa fecha.</div>
        {% else %}
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>HAB (Ontracking)</th>
                  <th>HAB (Log)</th>
                  <th>RUT</th>
                  <th>NOMBRE</th>
                  <th>EMPRESA</th>
                  <th>INICIO</th>
                  <th>TÉRMINO</th>
                  <th>APERTURAS (NOMBRE)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr {% if selected_room == r.on_room %}style="background: rgba(38,71,150,0.04);" {% endif %}>
                  <td>{{ r.on_room }}</td>
                  <td>{{ r.hk }}</td>
                  <td>{{ r.rut }}</td>
                  <td>{{ r.nombre }}</td>
                  <td>{{ r.empresa }}</td>
                  <td>{{ r.inicio }}</td>
                  <td>{{ r.termino }}</td>
                  <td>
                    {% if r.log_count > 0 %}
                      <span class="fw-semibold">{{ r.openers_text }}</span>
                      <div class="text-muted small">{{ r.log_count }} evento(s)</div>
                    {% else %}
                      <span class="text-muted">Sin log</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <a class="btn btn-outline-secondary btn-sm"
                       href="{{ url_for('conciliacion', date=date_str, per_page=per_page, page=page, room=r.on_room) }}">
                      Ver
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <nav class="mt-3">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('conciliacion', date=date_str, per_page=per_page, page=page-1, room=selected_room) }}">
                  Anterior
                </a>
              </li>
              <li class="page-item disabled"><span class="page-link">{{ page }}</span></li>
              <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link"
                   href="{{ url_for('conciliacion', date=date_str, per_page=per_page, page=page+1, room=selected_room) }}">
                  Siguiente
                </a>
              </li>
            </ul>
          </nav>
        {% endif %}
      </div>

      <!-- DERECHA: detalle de logs de la habitación seleccionada -->
      <div class="col-12 col-lg-5">
        <div class="p-3 bg-white border rounded-3 h-100">
          <div class="fw-semibold mb-2"><i class="fa-solid fa-id-card me-2"></i>Detalle</div>

          {% if not detail %}
            <div class="text-muted">Selecciona una habitación con “Ver”.</div>
          {% else %}
            <div class="mb-2">
              <span class="badge text-bg-light border">Ontracking: {{ detail.on_room }}</span>
              <span class="badge text-bg-light border">Log: {{ detail.hk }}</span>
              {% if detail.modulo %}<span class="badge text-bg-light border">Módulo: {{ detail.modulo }}</span>{% endif %}
              {% if detail.piso %}<span class="badge text-bg-light border">Piso: {{ detail.piso }}</span>{% endif %}
            </div>

            <div class="fw-semibold mb-1">Ontracking (DIA = {{ date_str }})</div>
            {% if detail.on_rows and detail.on_rows|length > 0 %}
              <div class="table-responsive mb-3">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>EMPRESA</th>
                      <th>CAMA</th>
                      <th>RUT</th>
                      <th>NOMBRE</th>
                      <th>INICIO</th>
                      <th>TÉRMINO</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for o in detail.on_rows %}
                    <tr>
                      <td>{{ o.empresa }}</td>
                      <td>{{ o.cama }}</td>
                      <td>{{ o.rut }}</td>
                      <td>{{ o.nombre }}</td>
                      <td>{{ o.inicio }}</td>
                      <td>{{ o.termino }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted small mb-3">Sin registro Ontracking.</div>
            {% endif %}

            <div class="fw-semibold mb-1">Log Tarjetas (eventos del día)</div>
            {% if detail.log_events and detail.log_events|length > 0 %}
              <div class="table-responsive">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>HORA</th>
                      <th>NRO TARJETA</th>
                      <th>NOMBRE (APERTURA)</th>
                      <th>MÉTODO</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in detail.log_events %}
                    <tr>
                      <td>{{ e.hora }}</td>
                      <td>{{ e.nro_tarjeta }}</td>
                      <td>{{ e.opener }}</td>
                      <td>{{ e.metodo }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted small">Sin eventos de log para esa fecha.</div>
            {% endif %}
          {% endif %}
        </div>
      </div>

    </div>
  {% endif %}
  {% endif %}
</div>
{% endblock %}
