{% extends "base.html" %}
{% block title %}Conciliación · Sistema de gestión de tarjetas{% endblock %}

{% block content %}
<div class="content-container">

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <div class="page-title mb-0">Conciliación</div>
      {% if has_data %}
      <div class="text-muted small">Última carga: {{ created_at }}</div>
      {% endif %}
    </div>
  </div>

  {% if not has_data %}
    <div class="text-muted">Sin datos para conciliar.</div>
  {% else %}

  <div class="filter-card mb-3">
    <form method="get" action="{{ url_for('conciliacion') }}" class="row g-2 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label fw-semibold mb-1">Fecha</label>
        <input class="form-control" type="date" name="date" value="{{ date_str or '' }}">
      </div>

      <div class="col-12 col-md-7">
        <label class="form-label fw-semibold mb-1">Habitación</label>
        <input class="form-control" type="text" name="habitacion" value="{{ habitacion or '' }}"
               placeholder="Ej: S1801 (Ontracking) o L1801-2 (Log)">
      </div>

      <div class="col-12 col-md-2 d-flex justify-content-end">
        <button class="btn btn-primary-custom w-100" type="submit">
          <i class="fa-solid fa-play me-1"></i> Buscar
        </button>
      </div>
    </form>
  </div>

  {% if not has_run %}
    <div class="text-muted">Selecciona fecha y habitación.</div>
  {% else %}

    <div class="mb-3">
      <span class="badge text-bg-light border">
        Ontracking: {{ on_room or '-' }}
      </span>
      <span class="badge text-bg-light border">
        Log: {{ log_room or '-' }}
      </span>
      {% if modulo %}
      <span class="badge text-bg-light border">Módulo: {{ modulo }}</span>
      {% endif %}
      {% if piso %}
      <span class="badge text-bg-light border">Piso: {{ piso }}</span>
      {% endif %}
      {% if map_found %}
      <span class="badge text-bg-success">Mapa OK</span>
      {% else %}
      <span class="badge text-bg-secondary">Sin mapa</span>
      {% endif %}
    </div>

    <div class="row g-3">
      <!-- ONTRACKING -->
      <div class="col-12 col-lg-6">
        <div class="p-3 bg-white border rounded-3 h-100">
          <div class="fw-semibold mb-2"><i class="fa-solid fa-bed me-2"></i>Ontracking (activa en la fecha)</div>

          {% if on_rows and on_rows|length > 0 %}
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>MÓDULO</th>
                  <th>LUGAR</th>
                  <th>HABITACIÓN</th>
                  <th>EMPRESA</th>
                  <th>CAMA</th>
                  <th>RUT</th>
                  <th>NOMBRE</th>
                  <th>INICIO</th>
                  <th>TÉRMINO</th>
                </tr>
              </thead>
              <tbody>
                {% for r in on_rows %}
                <tr>
                  <td>{{ r.MODULO }}</td>
                  <td>{{ r.LUGAR }}</td>
                  <td>{{ r.HABITACION }}</td>
                  <td>{{ r.EMPRESA }}</td>
                  <td>{{ r.CAMA }}</td>
                  <td>{{ r.RUT }}</td>
                  <td>{{ r.NOMBRE }}</td>
                  <td>{{ r.INICIO }}</td>
                  <td>{{ r.TERMINO }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="text-muted">Sin ocupación activa para esa fecha.</div>
          {% endif %}
        </div>
      </div>

      <!-- LOG TARJETAS -->
      <div class="col-12 col-lg-6">
        <div class="p-3 bg-white border rounded-3 h-100">
          <div class="fw-semibold mb-2"><i class="fa-solid fa-id-card me-2"></i>Log Tarjetas (eventos del día)</div>

          {% if log_rows and log_rows|length > 0 %}
          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>HORA</th>
                  <th>HABITACIÓN</th>
                  <th>NRO TARJETA</th>
                  <th>DUEÑO</th>
                  <th>MÉTODO</th>
                </tr>
              </thead>
              <tbody>
                {% for r in log_rows %}
                <tr>
                  <td>{{ r.HORA }}</td>
                  <td>{{ r.HABITACION }}</td>
                  <td>{{ r.NRO_TARJETA }}</td>
                  <td>{{ r["DUEÑO"] }}</td>
                  <td>{{ r.METODO }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <div class="text-muted">Sin eventos en el log para esa fecha.</div>
          {% endif %}
        </div>
      </div>

    </div>

  {% endif %}
  {% endif %}
</div>
{% endblock %}
